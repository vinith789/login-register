<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ALLWIN PRODUCT</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="./css/shop.css">
<link rel="stylesheet" href="./css/navbar.css">
<link rel="stylesheet" href="./css/footer.css">
</head>
<body>

<!-- Top Navbar -->
<div class="top-nav">
  <button id="orderbtn"><i class="fas fa-receipt"></i> Order</button>
  <button id="cartBtn">
    <i class="fas fa-shopping-cart"></i> Cart
    <span id="cartCount" class="cart-count"></span>
  </button>
</div>

<!-- Main Navbar -->
<div class="main-nav">
  <div class="logo-section">
    <img src="./image/logo.jpg" alt="Logo">
    <div class="shop-text">
      <h5>Allwin Baby Shop</h5>
      <small>Happy Toys Happy Kids</small>
    </div>
  </div>

  <!-- Hamburger / Close Icon -->
  <div class="hamburger" id="hamburger" onclick="toggleMenu()">
    <i class="fas fa-bars"></i>
  </div>

  <div class="nav-links" id="navLinks">
    <a href="/user/home">Home</a>
    <a href="/user/about">About</a>
    <a href="/user/shop">Shop</a>
    <a href="/user/mall">Fun Mall</a>
    <a href="/user/contact">Contact</a>
    <a href="/logout">Logout</a>
  </div>
</div>

  <div class="container">
    <!-- Sidebar Filters -->
    <div class="sidebar">
      <h3>Filters</h3>
      <div id="filters"></div>
    </div>

    <!-- Main Content -->
    <div class="content">
      <input type="text" id="search" placeholder="Search products..." class="search-bar" />

      <div id="products" class="product-grid"></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
<!-- Video Modal -->
<div id="videoModal" class="video-modal">
  <div class="video-content">
    <span class="close-btn" onclick="closeVideo()">&times;</span>
    <iframe id="videoFrame" width="100%" height="400" frameborder="0" allowfullscreen></iframe>
  </div>
</div>

<!-- footer content -->

<footer class="footer">
    <div class="footer-container">

      <!-- Logo & About -->
      <div class="footer-logo">
        <img src="./logo" alt="">
        <h2>Allwin Baby Shop</h2>
        <span>Happy Toys, Happy Kids</span>
        <p>Your trusted partner for quality toys that spark imagination and create joyful memories for children of all ages.</p>
        <div class="social-icons">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="footer-links">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="/user/about">About Us</a></li>
          <li><a href="/user/contact">Contact Us</a></li>
          <li><a href="/user/contact">FAQs</a></li>
          <li><a href="/user/shop">Shop</a></li>
          <li><a href="/user/mall">Fun Mall</a></li>
          <li><a href="/user/contact">Shipping Info</a></li>
        </ul>
      </div>

      <!-- Categories -->
      <div class="footer-categories">
        <h3>Categories</h3>
        <ul>
          <li><a href="/user/shop">Soft Toys</a></li>
          <li><a href="/user/shop">Educational Toys</a></li>
          <li><a href="/user/shop">Action Figures</a></li>
          <li><a href="/user/shop">Outdoor Toys</a></li>
          <li><a href="/user/shop">Dolls</a></li>
          <li><a href="/user/shop">Musical Toys</a></li>
        </ul>
      </div>

      <!-- Contact -->
      <div class="footer-contact">
        <h3>Contact Us</h3>
        <p><i class="fas fa-map-marker-alt"></i>Allwin Baby Shop, High School Road, Thirkadai Building, Paramathi Velur, Namakkal - 638182</p>
        <p><i class="fas fa-phone"></i>+91 99943 85838</p>
        <p><i class="fas fa-envelope"></i>hello@allwinbaby.com</p>

        <div class="store-hours">
          <strong>Store Hours</strong><br>
          Everyday: 09:30 AM - 9:00 PM<br>
        </div>
      </div>
    </div>

    <!-- Footer Bottom -->
    <div class="footer-bottom">
      ¬© 2025 Allwin Baby Shop. All rights reserved. Made with <span>‚ù§</span> for kids.
    </div>
  </footer>

<script>

let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
const perPage = 12;

// Fetch products
fetch("/api/products")
  .then(res => res.json())
  .then(products => {
    allProducts = products;
    filteredProducts = products;
    renderFilters(products);
    renderProducts();
  });

// Render Filters dynamically
function renderFilters(products) {
  const filterContainer = document.getElementById("filters");
  const grouped = {};

  products.forEach(p => {
    (p.catalogues || []).forEach(c => {
      const [key, value] = c.split(" - ");
      if (!grouped[key]) grouped[key] = new Set();
      grouped[key].add(value);
    });
  });

  filterContainer.innerHTML = Object.keys(grouped).map(key => `
    <div>
      <h4>${key}</h4>
      ${Array.from(grouped[key]).map(val => `
        <label>
          <input type="checkbox" value="${val}" data-key="${key}" onchange="applyFilters()" />
          ${val}
        </label><br>
      `).join("")}
    </div>
  `).join("");
}

// Apply Filters
function applyFilters() {
  const selected = {};
  document.querySelectorAll("#filters input:checked").forEach(cb => {
    const key = cb.getAttribute("data-key");
    if (!selected[key]) selected[key] = [];
    selected[key].push(cb.value);
  });

  filteredProducts = allProducts.filter(p => {
    return Object.keys(selected).every(k => {
      return (p.catalogues || []).some(c => {
        const [key, value] = c.split(" - ");
        return key === k && selected[k].includes(value);
      });
    });
  });

  currentPage = 1;
  renderProducts();
}

// Search by Name
document.getElementById("search").addEventListener("input", async e => {
  const term = e.target.value.toLowerCase();
  filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(term));
  currentPage = 1;
  renderProducts();

  // Send search log to server
  if(term.trim() !== ""){
    const userRes = await fetch("/get-user");
    const user = await userRes.json();

    await fetch("/log-search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: user.name,
        email: user.email,
        search: term
      })
    });
  }
});


// Render Products with Pagination
function renderProducts() {
  const container = document.getElementById("products");
  const start = (currentPage - 1) * perPage;
  const end = start + perPage;
  const pageProducts = filteredProducts.slice(start, end);

  function capitalizeWords(str) {
    return str.replace(/\b\w/g, char => char.toUpperCase());
  }

  container.innerHTML = pageProducts.map((p, idx) => {
    const discount = p.discount || 0;
    const finalPrice = Math.round(p.price * (1 - discount / 100));
    const productName = capitalizeWords(p.name);

    let colorsHTML = "";
    if (p.colors && p.colors.length > 0) {
      colorsHTML = `
        <div class="colors">
          <strong>Colors:</strong>
          ${p.colors.map(c => `
            <span class="color-circle" style="background:${c};" title="${c}"></span>
          `).join("")}
        </div>
      `;
    } else {
      colorsHTML = `<div class="colors"><strong>Colors:</strong> Default Color</div>`;
    }

return `
  <div class="product-card">
    <div class="card-content">
      <div class="img-wrapper">
        <img src="${p.image}" alt="${p.name}">
        ${discount > 0 ? `<span class="discount-badge">${discount}% OFF</span>` : ""}
      </div>
      <div class="tags">
        ${(p.catalogues || []).map(c => `<span class="tag">${c}</span>`).join(" ")}
      </div>
      <h4 class="product-name">${productName}</h4>
      <p class="price">
        <span class="final-price">‚Çπ${finalPrice}</span>
        <span class="old-price">‚Çπ${p.price}</span>
      </p>
      ${p.about ? `<p class="about">${p.about}</p>` : ""}
      ${colorsHTML}
    </div>

    <!-- Buttons always at bottom -->
    <div class="card-actions">
      <button class="view-btn"
          data-video="${p.description}"
          ${!p.description ? "disabled style='opacity:0.5; cursor:not-allowed;'" : ""}>
        VIEW PRODUCT
      </button>
      <button class="cart-btn" data-idx="${idx}">ADD TO CART</button>
    </div>
  </div>
`;

  }).join("");

  // üëâ Attach event listeners here
  document.querySelectorAll(".cart-btn").forEach((btn, idx) => {
    btn.addEventListener("click", () => addToCart(pageProducts[idx]));
  });

  document.querySelectorAll(".view-btn").forEach(btn => {
    btn.addEventListener("click", () => openVideo(btn.getAttribute("data-video")));
  });

  renderPagination();
}

// Open video modal
function openVideo(url) {
  const modal = document.getElementById("videoModal");
  const frame = document.getElementById("videoFrame");

  let embedUrl = "";

  if (url.includes("watch?v=")) {
    // long format: https://www.youtube.com/watch?v=VIDEOID
    embedUrl = url.replace("watch?v=", "embed/") + "?autoplay=1&mute=1";
  } else if (url.includes("youtu.be/")) {
    // short format: https://youtu.be/VIDEOID
    const videoId = url.split("youtu.be/")[1].split("?")[0];
    embedUrl = "https://www.youtube.com/embed/" + videoId + "?autoplay=1&mute=1";
  } else {
    embedUrl = url + "?autoplay=1&mute=1"; // fallback
  }

  frame.src = embedUrl;
  modal.style.display = "flex";
}

// Close video modal
function closeVideo() {
  const modal = document.getElementById("videoModal");
  const frame = document.getElementById("videoFrame");
  frame.src = ""; // stop video
  modal.style.display = "none";
}

document.querySelectorAll(".view-btn").forEach(btn => {
  btn.addEventListener("click", () => openVideo(btn.getAttribute("data-video")));
});


function getCart(){ return JSON.parse(localStorage.getItem("cart") || "[]"); }
function saveCart(c){ localStorage.setItem("cart", JSON.stringify(c)); }


// After adding to cart
// ...existing code...
async function addToCart(item) {
  const userRes = await fetch("/get-user");
  const user = await userRes.json();

  const res = await fetch("/api/cart", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: user.email,
      productId: item._id,
      name: item.name,
      image: item.image,
      price: item.price,
      discount:item.discount,
      colors:item.colors,
      qty: 1
    })
  });

  const data = await res.json();
  alert(data.message);

  // üëâ refresh cart count
  updateCartCount();
}

//page redirect for add to cart

document.getElementById("cartBtn").addEventListener("click", () => {
  window.location.href = "/user/cart"; // goes to your new cart page
});


function renderPagination() {
  const totalPages = Math.ceil(filteredProducts.length / perPage);
  const container = document.getElementById("pagination");
  container.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    container.innerHTML += `<button onclick="goToPage(${i})" ${i === currentPage ? "disabled" : ""}>${i}</button>`;
  }
}

function goToPage(page) {
  currentPage = page;
  renderProducts();
}
</script>

<script src="./js/cart-number.js"></script>
<script src="./js/script.js"></script>


</body>
</html>
