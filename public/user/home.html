<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Home</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>

  <div class="welcome-container">
    <h2>Welcome, <span id="userName"></span>!</h2>
    <p>Email: <span id="userEmail"></span></p>
    <a href="/logout">Logout</a>
  </div>

  <div class="container">
    <!-- Sidebar Filters -->
    <div class="sidebar">
      <h3>Filters</h3>
      <div id="filters"></div>
    </div>

    <!-- Main Content -->
    <div class="content">
      <input type="text" id="search" placeholder="Search products..." class="search-bar" />

      <div id="products" class="product-grid"></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

<script>
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
const perPage = 6;

// Fetch user info
fetch("/get-user")
  .then(res => res.json())
  .then(data => {
    document.getElementById("userName").textContent = data.name;
    document.getElementById("userEmail").textContent = data.email;
  });

// Fetch products
fetch("/api/products")
  .then(res => res.json())
  .then(products => {
    allProducts = products;
    filteredProducts = products;
    renderFilters(products);
    renderProducts();
  });

// Render Filters dynamically
function renderFilters(products) {
  const filterContainer = document.getElementById("filters");
  const grouped = {};

  products.forEach(p => {
    (p.catalogues || []).forEach(c => {
      const [key, value] = c.split(" - ");
      if (!grouped[key]) grouped[key] = new Set();
      grouped[key].add(value);
    });
  });

  filterContainer.innerHTML = Object.keys(grouped).map(key => `
    <div>
      <h4>${key}</h4>
      ${Array.from(grouped[key]).map(val => `
        <label>
          <input type="checkbox" value="${val}" data-key="${key}" onchange="applyFilters()" />
          ${val}
        </label><br>
      `).join("")}
    </div>
  `).join("");
}

// Apply Filters
function applyFilters() {
  const selected = {};
  document.querySelectorAll("#filters input:checked").forEach(cb => {
    const key = cb.getAttribute("data-key");
    if (!selected[key]) selected[key] = [];
    selected[key].push(cb.value);
  });

  filteredProducts = allProducts.filter(p => {
    return Object.keys(selected).every(k => {
      return (p.catalogues || []).some(c => {
        const [key, value] = c.split(" - ");
        return key === k && selected[k].includes(value);
      });
    });
  });

  currentPage = 1;
  renderProducts();
}

// Search by Name
document.getElementById("search").addEventListener("input", async e => {
  const term = e.target.value.toLowerCase();
  filteredProducts = allProducts.filter(p => p.name.toLowerCase().includes(term));
  currentPage = 1;
  renderProducts();

  // Send search log to server
  if(term.trim() !== ""){
    const userRes = await fetch("/get-user");
    const user = await userRes.json();

    await fetch("/log-search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: user.name,
        email: user.email,
        search: term
      })
    });
  }
});


// Render Products with Pagination
function renderProducts() {
  const container = document.getElementById("products");
  const start = (currentPage - 1) * perPage;
  const end = start + perPage;
  const pageProducts = filteredProducts.slice(start, end);

container.innerHTML = pageProducts.map(p => `
  <div class="product-card">
    <img src="${p.image}" alt="${p.name}">
    <h4>${p.name}</h4>
    <p>â‚¹${Math.round(p.price * (1 - (p.discount||0)/100))} <small>(${p.discount||0}% off)</small></p>
    <button onclick='addToCart(${JSON.stringify({ _id:p._id, name:p.name, image:p.image, price:Math.round(p.price*(1-(p.discount||0)/100)) }).replace(/"/g, "&quot;")})'>
      Add to Cart
    </button>
  </div>
`).join("");



  renderPagination();
}

function getCart(){ return JSON.parse(localStorage.getItem("cart") || "[]"); }
function saveCart(c){ localStorage.setItem("cart", JSON.stringify(c)); }

function addToCart(item){
  const cart = getCart();
  const idx = cart.findIndex(x => x.productId === item._id);
  if (idx > -1) { cart[idx].qty += 1; cart[idx].subtotal = cart[idx].qty * cart[idx].price; }
  else { cart.push({ productId: item._id, name:item.name, image:item.image, price:item.price, qty:1, subtotal:item.price }); }
  saveCart(cart);
  alert("Added to cart");
  // optional: window.location.href = "/cart.html";
}

function renderPagination() {
  const totalPages = Math.ceil(filteredProducts.length / perPage);
  const container = document.getElementById("pagination");
  container.innerHTML = "";

  for (let i = 1; i <= totalPages; i++) {
    container.innerHTML += `<button onclick="goToPage(${i})" ${i === currentPage ? "disabled" : ""}>${i}</button>`;
  }
}

function goToPage(page) {
  currentPage = page;
  renderProducts();
}
</script>




</body>
</html>
